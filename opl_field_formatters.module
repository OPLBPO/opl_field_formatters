<?php

/**
 * @file
 * Custom field formatters module
 *
 */

/**
 * Implements hook_field_formatter_info().
 */

function opl_field_formatters_field_formatter_info() {
  return array(
    'event_card_dates' => array(
      'label' => t('Event card dates'),
      'field types' => array('datestamp'),
    ),
    'event_node_full_dates' => array(
      'label' => t('Event node full dates'),
      'field types' => array('datestamp'),
    ),
    'blog_category_search_link' => array(
      'label' => t('Blog category search API link-back'),
      'field types' => array('entityreference'),
    ),
    'branch_title_with_address' => array(
      'label' => t('Branch title with address'),
      'field types' => array('entityreference'),
    ),
    'event_add_to_calendar' => array(
      'label' => t('OPL add event to calendar'),
      'field types' => array('datestamp'),
    ),

  );
}

/**
 * Implements hook_field_formatter_view().
 */

function opl_field_formatters_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  global $language;
  $lang = $language->language;
  $element = array();
  $settings = $display['settings'];

  switch ($display['type']) {
    case 'event_card_dates':
      //dpm($items);
      //dpm($entity);
      $event_status = isset($entity->field_event_status['en'][0]['value']) ? $entity->field_event_status['en'][0]['value'] : $entity->field_event_status[LANGUAGE_NONE][0]['value'];
      $sorted_dates = array();
      foreach ($items as $delta => $item) {
        if ($item['value'] > time()) {
          $sorted_dates[] = $item;
        }
      }
      //dpm($sorted_dates);

      $date_count = count($sorted_dates);
      if ($lang == 'en') {
        if ($event_status <> 'active') {
          $element[0]['#markup'] = '<p>' . t('Sorry, this event has been cancelled.') . '</p>';
        }
        elseif ($date_count == 0) {
          $element[0]['#markup'] = '<p>' . t('This event has passed.') . '</p>';
        }
        elseif ($date_count == 1) {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . format_date($sorted_dates[0]['value'], 'custom', ' l ') . format_date($sorted_dates[0]['value'], 'event_day') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        } else {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . format_date($sorted_dates[0]['value'], 'custom', ' l') . 's, ' . t(' until ') . format_date($sorted_dates[$date_count - 1]['value'], 'event_day') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        }
      } else {
        setlocale(LC_ALL, 'fr_CA.utf8');
        if ($event_status <> 'active') {
          $element[0]['#markup'] = '<p>' . t('Sorry, this event has been cancelled.') . '</p>';
        }
        elseif ($date_count == 0) {
          $element[0]['#markup'] = '<p>' . t('This event has passed.') . '</p>';
        }
        elseif ($date_count == 1) {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . 'Le ' . format_date($sorted_dates, 'custom', ' l ') . format_date($sorted_dates, 'event_day') . t(' at ') . format_date($sorted_dates, 'event_time') . '</p>';
        } else {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . 'Les ' . strtolower(trim(format_date($sorted_dates[0]['value'], 'custom', ' l'))) . 's, ' . t(' until ') . format_date($sorted_dates[$date_count - 1]['value'], 'custom', 'j F') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        }
      }
      break;

    case 'event_node_full_dates':
     // dpm($items);
      $event_status = isset($entity->field_event_status['en'][0]['value']) ? $entity->field_event_status['en'][0]['value'] : $entity->field_event_status[LANGUAGE_NONE][0]['value'];
      $start_date = $items[0]['value'];
      $sorted_dates = array();
      foreach ($items as $delta => $item) {
        if ($item['value'] > time()) {
          $sorted_dates[] = $item;
        }
      }
      // dpm($sorted_dates);

      $date_count = count($sorted_dates);
      if ($lang == 'en') {
        if ($event_status == 'cancelled') {
          $element[0]['#markup'] = '<p>' . t('Sorry, this event has been cancelled.') . '</p>';
        }
        elseif ($date_count == 0) {
          $element[0]['#markup'] = '<p>' . t('This event has passed.') . '</p>';
        }
        elseif ($date_count == 1) {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . format_date($sorted_dates[0]['value'], 'custom', ' l ') . format_date($sorted_dates[0]['value'], 'event_day') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        } else {
         // $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . t('Start date: ') . format_date($start_date, 'event_day') . '<br/>' . format_date($sorted_dates[0]['value'], 'custom', ' l') . 's, ' . t(' until ') . format_date($sorted_dates[$date_count - 1]['value'], 'event_day') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . format_date($sorted_dates[0]['value'], 'custom', ' l') . 's, ' . format_date($start_date, 'event_day') . t(' - ') . format_date($sorted_dates[$date_count - 1]['value'], 'event_day') . '<br/>' . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';

        }
      } else {
        setlocale(LC_ALL, 'fr_CA.utf8');
        if ($event_status == 'cancelled') {
          $element[0]['#markup'] = '<p>' . t('Sorry, this event has been cancelled.') . '</p>';
        }
        elseif ($date_count == 0) {
          $element[0]['#markup'] = '<p>' . t('This event has passed.') . '</p>';
        }
        elseif ($date_count == 1) {
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . 'Le ' . format_date($sorted_dates[0]['value'], 'custom', ' l ') . format_date($sorted_dates[0]['value'], 'event_day') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        } else {
         // $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . t('Start date: ') . format_date($start_date, 'event_day') . '<br/>' . 'Les ' . strtolower(trim(format_date($sorted_dates[0]['value'], 'custom', ' l'))) . 's, ' . t(' until ') . format_date($sorted_dates[$date_count - 1]['value'], 'custom', 'j F') . t(' at ') . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
          $element[0]['#markup'] = '<p class="card-date"><span><i class="fa fa-clock-o" aria-hidden="true"></i></span> ' . 'Les ' . strtolower(trim(format_date($sorted_dates[0]['value'], 'custom', ' l'))) . 's, ' . format_date($start_date, 'custom', 'j F, Y') . t(' - ') . format_date($sorted_dates[$date_count - 1]['value'], 'custom', 'j F, Y') . '<br/>' . format_date($sorted_dates[0]['value'], 'event_time') . '</p>';
        }
      }
      break;

    case 'blog_category_search_link':
     // dpm($items);
      foreach ($items as $delta => $item) {
        $tid = $item['target_id'];
        $term = taxonomy_term_load($tid);
        $translated_term = i18n_taxonomy_localize_terms($term);

        $display_terms = l(
            $translated_term->name,
            'staff-blogs',
            array('query' => array('f[' . $delta . ']'=>'taxonomy_vocabulary_21:'.$tid
            )));


        $element[$delta]['#markup'] = $display_terms;
      }

      break;

    case 'branch_title_with_address':
     // dpm($items);
      foreach ($items as $delta => $item) {
        $nid = $item['target_id'];
        $node = node_load($item['target_id']);
        $address = $node->field_branch_location[LANGUAGE_NONE][0]['street'];
      //  dpm($node);

        $link = l(
            $node->title,
            drupal_get_path_alias('node/' . $nid, $lang)) . '<br/><div class="street-address">' . $address . '</div>';


        $element[$delta]['#markup'] = $link;
      }

      break;
    
    case 'event_add_to_calendar':
      $event_status = isset($entity->field_event_status['en'][0]['value']) ? $entity->field_event_status['en'][0]['value'] : $entity->field_event_status[LANGUAGE_NONE][0]['value'];
      $nid = $entity->nid;
      if ($event_status <> 'cancelled') {
        $link = l(t('Add this event to your calendar'), 'node/' . $nid . '/opl_add_to_calendar.ics', array('attributes' => array('class' => array('add-cal'))));
      } else {
        $link = NULL;
      }
      $element[0]['#markup'] = $link;

      break;
  }

  //dpm($element);

  return $element;
}



/**
 * Implements hook_menu().
 */
function opl_field_formatters_menu() {
  $items = array();

  $items['node/%node/opl_add_to_calendar.ics'] = array(
      'title' => t('Add to Calendar'),
      'page callback' => 'opl_field_formatters_ics_download',
      'page arguments' => array(1),
      'access callback' => 'node_access',
      'access arguments' => array('view', 1),
      'type' => MENU_CALLBACK,
  );

  return $items;
}




//Calendar functions

function opl_field_formatters_ics_download($node) {
  global $language;
  $lang = $language->language;

  drupal_add_http_header('Content-Type','text/calendar; charset=utf-8;');
  drupal_add_http_header('Content-Disposition','inline; filename="add_to_calendar.ics";');

// 	$description = t("Read more at !link", array('!link' => url('node/' . $node->nid, array('absolute' => TRUE))));
  $description = isset($node->body['en'][0]['safe_value']) ? $node->body['en'][0]['safe_value'] : $node->body[LANGUAGE_NONE][0]['safe_value'];
  $created = date("Ymd\THis\Z",$node->created);
  $reservations = opl_reservation_load_by_nid($node->nid);
  if (isset($reservations) && !empty($reservations)) {
    $dates = array();
    // $loc_details = array();
    foreach ($reservations as $rid => $reservation) {
      $dates[] = $reservation->field_reservation_date[LANGUAGE_NONE][0]['value'];
    }
  }
  $title = $node->title;
  $date_c = array();
  $branch_id = $node->field_event_branch[LANGUAGE_NONE][0]['target_id'];
  $branch = node_load($branch_id);
  $branch_name = $branch->title;

  foreach ($dates as $key => $value) {
    if (isset($value) && !empty($value) && $value >= strtotime('today')) {
      $date_c[] = $value;
    }
  }
  $duration = $reservation->field_event_duration[LANGUAGE_NONE][0]['value'];
  $date_output = '';
  foreach ($date_c as $did=>$date) {
    $startdate = date("Ymd\THis",$date);
    $enddate = date("Ymd\THis",($date + ($duration * 60)));
    $date_output .= "BEGIN:VEVENT
DTSTAMP:$created
UID:event$node->nid-$did@biblioottawalibrary.ca
ORGANIZER;CN=Ottawa Public Library:MAILTO:infoservice@biblioottawalibrary.ca
DTSTART;TZID=America/Toronto:$startdate
DTEND;TZID=America/Toronto:$enddate
SUMMARY:$title
DESCRIPTION:$description
LOCATION:$branch_name
SEQUENCE:0
END:VEVENT\r\n";
  }

  print "BEGIN:VCALENDAR
PRODID:-//Calendar//Calendar Event//EN
VERSION:2.0
METHOD:PUBLISH
$date_output
END:VCALENDAR";
  exit();
}
